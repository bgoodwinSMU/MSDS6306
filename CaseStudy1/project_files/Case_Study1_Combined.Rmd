---
title: "DS6306: Cast Study 01"
author: "Ben Goodwin/ Justin Ehly"
date: "10/6/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction #########
#
#
# The following is an analysis of one-hundred styles of beer brewed in the United States for the executive team,
# CEO and CFO at Budweiser. Budweiser is interested in exploring the how many breweries are in the United States, 
# how each beer is reported in terms of its International Bitterness Unit and Alcohol By Content and basic summary
# statistics and conclusions we are able to uncover with the beer data provided. Statistics will include handling
# missing data and explaining why it was possibly not included in the initial dataset, as well as uncover median 
# and maximum (IBU and ABV) ratings by state. Conclusions will include basic summary statics on the ABV variable, 
# any relationship between the IBU and ABV variables (such as dependencies, e.g. does a higher IBU result in a 
# higher ABV) and finally we will look to see if we can determine general beer styles (Ales and IPAs) based on 
# ABV and IBU values. Additionally, we will report on any findings that are discovered during the analysis.


```{r}
######################
#                    #
#     Libraries      #
#                    #
######################
######################
library(usmap)
library(ggplot2)
library(magrittr)
library(ggplot2)
library(GGally)
library(readr)
library(tibble)
library(tidyverse)
library(robustbase)
library(plyr)
library(class)
library(caret)
library(e1071)
library(dplyr)
######################
######################
#                    #
#        Data        #
#                    #
######################
########################################################
#read in brewery data
setwd("C:/Users/justi/Documents/GitHub/MSDS6306/CaseStudy1/project_files/") 
breweryDat <- read.csv("breweries.csv")
breweryDat$State <- trimws(breweryDat$State)

#datafile to organize states into census regions
regionData <- read.csv("state-geocodes-v2017.csv")
regionData <- regionData[,c(-1,-2)]
regionData <- dplyr::rename(regionData, "FIPS"="State..FIPS.", "Region" = "Region.1", "Division" = "Division.1")
regionData$State <- trimws(regionData$State)
#Ensure structure of data is compliant 
#head(breweryDat)
#read in beer data
beerDat <- read.csv("beers.csv")
#Loop to fix leading decimal places on ABV
i <- 1
count <- length(beerDat$Name)
for (i in 1:count) {
 if(is.na(beerDat[i,3])){
  beerDat[i,3]=0
   }
   if(beerDat[i,3]<1){
    beerDat[i,3] <- beerDat[i,3]*100
  }
}


#Ensure structure of data is compliant 
#head(beerDat)
########################################################
```
# Question 1 - How many breweries are in each state?
#
# During this analysis, we explored how many breweries are in each state and grouped the states 
# by US Census Divisions. The data is visually displayed using maps of each USC Division below 
# and summarized in a simple chart at the end.


```{r}
######################
#                    #
#     Question 1     #
#                    #
######################
########################################################
#How many breweries are present in each state?
#
########################################################
#########################################################
#Use Dplyr to group breweries by state
brewByState <- breweryDat %>% group_by(State) %>% count()
#########################################################
#########################################################
#Add breweries by state to state information dataframe
statepop$brewByState <- brewByState$n
#########################################################
#########################################################
#Fix mismatched state brewery count to state info df
statepop[1,5] <- 3
statepop[2,5] <- 7
statepop[3,5] <- 11
statepop[4,5] <- 2
statepop[8,5] <- 2
statepop[9,5] <- 1
statepop[14,5] <- 18
statepop[15,5] <- 22
statepop[16,5] <- 5
statepop[20,5] <- 9
statepop[22,5] <- 23
statepop[25,5] <- 2
statepop[26,5] <- 9
statepop[28,5] <- 5
statepop[29,5] <- 2
statepop[30,5] <- 3
statepop[32,5] <- 4
statepop[34,5] <- 19
statepop[33,5] <- 16
statepop[35,5] <- 1
statepop[45,5] <- 4
statepop[46,5] <- 10
statepop[47,5] <- 16
statepop[49,5] <- 1
statepop[50,5] <- 20
#Check data 
#View(statepop)
#View(brewByState)
#########################################################
#########################################################
#Call plot functions to plot state brewery count on USmap
nationBrewPlot <- plot_usmap(data = statepop, values = "brewByState",labels=TRUE, color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma) + theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
#display plot
nationBrewPlot
#########################################################
#########################################################
#Break down by region, NE first
NEplot <- plot_usmap(data=statepop, values = "brewByState",labels = TRUE,include = .new_england,color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma)+ theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
NEplot
#########################################################
#########################################################
#Break down by region, Mid Atlantic second
MAplot <- plot_usmap(data=statepop, values = "brewByState",labels = TRUE,include = .mid_atlantic,color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma)+ theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
MAplot
#########################################################
#########################################################
#Break down by region, East North Central third
ENCplot <- plot_usmap(data=statepop, values = "brewByState",labels = TRUE,include = .east_north_central,color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma)+ theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
ENCplot
#########################################################
#########################################################
#Break down by region, West North Central fourth
WNCplot <- plot_usmap(data=statepop, values = "brewByState",labels = TRUE,include = .west_north_central,color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma)+ theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
WNCplot
#########################################################
#########################################################
#Break down by region, South Atlantic fifth
SAplot <- plot_usmap(data=statepop, values = "brewByState",labels = TRUE,include = .south_atlantic,color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma)+ theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
SAplot
#########################################################
#########################################################
#Break down by region, East South Central sixth
ESCplot <- plot_usmap(data=statepop, values = "brewByState",labels = TRUE,include = .east_south_central,color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma)+ theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
ESCplot
#########################################################
#########################################################
#Break down by region, West South Central seventh
WSCplot <- plot_usmap(data=statepop, values = "brewByState",labels = TRUE,include = .west_south_central,color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma)+ theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
WSCplot
#########################################################
#########################################################
#Break down by region, Mountain eighth 
Mplot <- plot_usmap(data=statepop, values = "brewByState",labels = TRUE,include = .mountain,color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma)+ theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
Mplot
#########################################################
#########################################################
#Break down by region, Pacific ninth 
Pplot <- plot_usmap(data=statepop, values = "brewByState",labels = TRUE,include = .pacific,color = "grey73") + scale_fill_continuous(low = "purple", high = "green", name = "Brewery Count", label = scales::comma)+ theme(legend.position = "bottom")+labs(title = "Total Brewery Count Per State")
Pplot
#########################################################
#########################################################

#### Bar Plot ####

#Plot overall breweries by state in bar chart

brewByState %>% ggplot(aes(y=reorder(State, n), x= n, fill = "#C8102E")) +
  geom_bar(stat = "identity", show.legend = FALSE, position = 'dodge') +
  geom_text(aes(label = brewByState$n), position=position_dodge(width=0.9), hjust = -0.25, vjust= .2, size = 3) +
  theme_classic() + 
  labs(title = "Breweries by State in the USA", 
       subtitle = "Budweiser Consultation",
       x = "Number of Breweries", y = "State")



```

# Question 2 - Merge the individual data sets
#
# We merged the breweries.csv dataset with the beers.csv dataset, additionally when we imported
# the individual datasets, we also imported a dataset that allows us to associate each beer with 
# its brewery's US Census Division.  

```{r}
######################
#                    #
#     Question 2     #
#                    #
######################
#############################################################################################################
#Merge beer data with the breweries data. Print the first 6 observations and the last six observations to check the merged file.  (RMD only, this does not need to be included in the presentation or the deck.)
#############################################################################################################
#Use Dplyr package to merge the two tables together
buzzbrews <- merge(breweryDat, beerDat, by.x = "Brew_ID", by.y = "Brewery_id", all = TRUE )
#Use Dplyr package to rename "Name.x" to "Brewery" and "Name.y" to "Beer"
buzzbrews <- dplyr::rename(buzzbrews, "Brewery" = "Name.x","Beer"="Name.y")
bzbwTestDf <- buzzbrews
#Check the results
#View(buzzbrews)
```

# Question 3 - Address the missing values in each column.
#
# During the initial exploratory process we discovered NA's in both the IBU and ABV columns. 
# Upon further investigation we determined that some styles of beer, mixed or barrel aged beers
# do not have an ABV available at the time the brewery submits packaging labels to TTB, or Alcohol
# and Tobacco Tax and Trade Bureau. The TTB is the federal agency that determines what can and cannot
# be put on a beer label including the art, type size, verbiage, where elements are placed and etc.
# So beers without an AVB available either do not inlcude it, or add it to the bottom of the cans 
# or packaging at a later date. 

# In terms of the missing IBU values, we determined that even though the IBU alludes to the bitterness
# of a beer's taste, it is somewhat misleading because it is derived from a test that measures different
# chemical compounds that are known to cause bitter flavoring. For instance, a beer may have a high IBU 
# value, but due to other ingredients, such as added lactose or sucrose may actually have a sweeter taste 
# than would be expected from a high IBU. The other comfounding variable is if the brewery can afford the 
# equipment used to generate an IBU value, smaller breweries simply cannot afford it while the larger 
# breweries typically just use IBU as a quality control measure.

# Finally, we concluded that imputing data or filling in the missing gaps was a good idea for this
# analysis and that was done by taking an average of from similiar styles of beer and assigning that to
# beers in the same sytle classification that did not have values. Upon random testing of different imputed
# values, by googling beers that had missing values in the dataset and comparing that to the created averages,
# it was determined that the imputed values were very close to the actual values in the marketplace.

```{r}
######################
#                    #
#     Question 3     #
#                    #
######################
###########################################
#Address the missing values in each column
###########################################
#Loop to fix numbering for Column 1 "brew ID"
iterations <- length(buzzbrews$Brew_ID)
for (i in 1:iterations) {
  buzzbrews[i,1]=i
}
#Fix no style beers to none
levels(buzzbrews$Style) <- c(levels(buzzbrews$Style), "none")
for (i in 1:iterations) {
  if(is.na(buzzbrews[i,9])){
  }
}
for (i in 1:iterations) {
  if((buzzbrews[i,9])==''){
    #print(buzzbrews[i,9])
    buzzbrews[i,9]="none"
  }
}
#Prep new df to contain style and averages
buzzbrews$Style <- as.factor(buzzbrews$Style)
#Create a data frame with each style and a variable for average IBU
styleCount <- as.data.frame(levels(buzzbrews$Style))
styleCount$`levels(buzzbrews$Style)` <- as.character(styleCount$`levels(buzzbrews$Style)`)
#View(styleCount)
#Initialize mean ibu to zero (to avoid problems with N/As)
styleCount$meanIbu <- 0
#Make beer count to keep track of total in each style
styleCount$beerCount <- 0
#Make column for total ibus
styleCount$totalIBU <- 0
styleCount$meanABV <- 0
styleCount$ABVbeerCount <- 0
styleCount$totalABV <- 0
#Checking
#View(styleCount)
#styleCount <- styleCount[-c(1), ]
#View(styleCount)
#Calculate mean IBU for each category and store it in IBU df
#Calculate average IBU for each style and add it to df
#outer loop for all the beers
ibuSum <- 0
beerCount <- 0
i <- 1
for (i in 1:iterations) {
  if(is.na(buzzbrews[i,8])) {
    buzzbrews[i,8]=0
  }
  
  #inner for each style
  for (j in 1:100) {
      
    if(buzzbrews[i,9]==styleCount[j,1]){
     #Compute IBU sum
     styleCount[j,4] <- styleCount[j,4]+buzzbrews[i,8]
     
     
     
     #Total of each beer count
     styleCount[j,3] <- styleCount[j,3]+1
     
     if(buzzbrews[i,8]==0){
       styleCount[j,3] <- styleCount[j,3]-1
     }
    
     
     
    }
    #Mean IBU for each style
    styleCount[j,2] <- styleCount[j,4]/styleCount[j,3]
    }}
#Add average column from style count to buzzbrews df
for (i in 1:iterations) {
  if(buzzbrews[i,8]==0){
    for(j in 1:100){
      if(buzzbrews[i,9]==styleCount[j,1]){
        buzzbrews[i,8]=styleCount[j,2]
      }
    }
  }
}
#View(styleCount)
#View(buzzbrews)
#Now do it all again for ABV
#Calculate average ABV for each style and add it to df
#outer loop for all the beers
AlcSum <- 0
AlcVeerCount <- 0
i <- 1
for (i in 1:iterations) {
  if(is.na(buzzbrews[i,7])) {
   buzzbrews[i,7]=0
  }
  
  
  #inner for each style
  for (j in 1:100) {
   
    if(buzzbrews[i,9]==styleCount[j,1]){
     
     #Compute ALC sum
     styleCount[j,7] <- styleCount[j,7]+buzzbrews[i,7]*100
     
     
     
     #Total of each beer count
     styleCount[j,6] <- styleCount[j,6]+1
     
     if(buzzbrews[i,7]==0){
       styleCount[j,6] <- styleCount[j,6]-1
     }
    
     
     
    }
    #Mean ABV for each style
    styleCount[j,5] <- (styleCount[j,7]/styleCount[j,6])/100
    }
}
#Add average column from style count to buzzbrews df
for (i in 1:iterations) {
  if(buzzbrews[i,7]==0){
    for(j in 1:100){
      if(buzzbrews[i,9]==styleCount[j,1]){
        buzzbrews[i,7]=styleCount[j,5]
        
      }
      }
  }
}
#kill NaN's for other alcohol types with no hops
i <- 1
for(i in 1:iterations){
  if(is.na(buzzbrews[i,8])){
    buzzbrews[i,8] <- 0
  }
}
#Check out end results
buzzbrews <- merge(buzzbrews, regionData, by = "State")

View(buzzbrews)
```

# Question 4 - Compute the median alcohol content and international bitterness unit for 
# each state. Plot a bar chart to compare.
#
# We computed the median ABV and IBU for each state and created a visualisation that allowed
# us to further explore what those medians tell us. We found there appears to be a relationship
# between IBU and ABV where we can use IBU to estimate ABV of a given beer. 
#
# We explored this further by developing a model to make predictions based on historical IBU
# and ABV data and were able to predict that a beer with 32 IBU could have an ABV of 5.72% and
# we were 97.5% confident that beer would at least fall between 3.24% and 8.21%.


```{r}
######################
#                    #
#     Question 4     #
#                    #
######################
#################################################################################################################
#Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare
#################################################################################################################
#Create new DF for this question
q4DF <- buzzbrews
q4DF$State <- trimws(q4DF$State)
#Group by state and compute median ABV
medABVstate <- q4DF %>% group_by(State) %>% summarise_at("ABV",median)
medABVstate$State <- trimws(medABVstate$State)
#testing
#medABVstate
#Group by state and compute median ABV
medIBUstate <- q4DF %>% 
  group_by(State) %>% 
  dplyr::summarise(IBU = median(IBU),n=n())
medIBUstate$State <- trimws(medIBUstate$State)
#testing
#medIBUstate

#Combine dfs into one
combineddf <- merge(medABVstate,medIBUstate,by="State")
view(combineddf)
#change to DF
combineddf <- as.data.frame(combineddf)
#Change column names 
combineddf <- dplyr::rename(combineddf, "Median ABV" = "ABV", "Median IBU"="IBU", "State Beer Count"="n")
#testing
names(combineddf)
head(combineddf)
#Create bar plot for ABV
#Sort ABV
#remove = sortedABV <- combineddf[order(combineddf$`Median ABV`), ] 
#This line is to retain sort in plot
#remove - sortedABV$State <- factor(sortedABV$State, levels = sortedABV$State)

# Draw plot

ggplot(combineddf, aes(x=reorder(State, `Median ABV`), y=`Median ABV`)) +   geom_bar(stat="identity", width=.5, fill="#c8102e") + 
  geom_text(aes(label = `Median ABV`), hjust = "center", vjust= -.4, size = 3) +
  labs(title = "Median ABV by State in the USA", 
       subtitle = "Budweiser Consultation",
       y = "Median Alcoholic Content by Volume of Beer",
       x = "State by ABV Median Score",
       caption = "ABV imputed where necessary.") + 
theme_minimal() +
theme(axis.text.x = element_text(angle=65, vjust=0.6))


##### Create bar plot for IBU #####
#Sort IBU
#remove - sortedIBU <- combineddf[order(combineddf$`Median IBU`), ] 
#This line is to retain sort in plot
#remove - sortedIBU$State <- factor(sortedIBU$State, levels = sortedIBU$State)

# Draw plot
ggplot(combineddf, aes(x=reorder(State,`Median IBU` ), y=`Median IBU`)) +   geom_bar(stat="identity", width=.5, fill="#c8102e") + 
  geom_text(aes(label = sprintf("%0.1f", round(`Median IBU`, digits = 1))), hjust =-0.1, vjust=0.3, size = 3, angle = 90) +
  labs(title="Median IBU by State in the USA", 
       subtitle="Budweiser Consultation", 
       caption="source: IBU. IBU imputed where necessary.",
       y = "Median Int'l Bitterness Unit",
        x = "State Ordered by Median IBU Score") + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle=65, vjust=0.6))
####################################################
##                                                ##
## Scatterplot Median IBU vs Median ABV by State  ##
##                                                ##
####################################################

## Calculate slope and intercept of line of best fit ##
coef(lm(`Median IBU` ~ `Median ABV`, combineddf))
#  (Intercept) `Median ABV` 
#   14.5377926    0.4013998 

combineddf$State <- trimws(combineddf$State)
ovr_med_IBU <- median(combineddf$`Median IBU`)

ovr_med_ABV <- median(combineddf$`Median ABV`)

ggplot(combineddf,aes(x = `Median ABV`, y = `Median IBU`, color = State)) +
  geom_point(show.legend = FALSE) +
  geom_abline(intercept = 14.5377926 , slope = 0.4013998 , color = "#c8102E", size = 1)+   geom_text(data = subset(combineddf,`Median IBU` > 40 | `Median ABV` < 4.5, select = c(State, `Median IBU`, `Median ABV`)), aes(label = State), vjust= -0.6, size = 3, na.rm = TRUE, show.legend = FALSE, color = "#000000") +
  theme_classic() + 
  labs(title = "Media ABV vs Median IBU", 
       subtitle = "Budweiser Consultation",
       x = "Median Alcoholic By Vol", 
       y = "Median Int'l Bitterness Unit",
       caption = "NOTE: Missing ABV and IBU values imputed")

```

# Question 5 - Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?
#
# We determined that the maximum observed IBU was 138 in Oregon for Bitter Bitch Imperial IPA that 
# is an American Double/ Imperial IPA from the Astoria Brewing Company in Austoria, OR. 
# 
# We also determined that maximum observed ABV was 12.8% in Colorado for Lee Hill Series Vol. 5 – 
# Belgian Style Quadrupel Ale from Upslope Brewing Company in Boulder, CO.



```{r}
######################
#                    #
#     Question 5     #
#                    #
######################
#############################################################################################################
#Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?
#############################################################################################################
#Figure out which has highest ABV
maxABV <- arrange(buzzbrews, desc(ABV))
print(maxABV[1,4])
#Figure out which has highest IBU
maxIBU <- arrange(buzzbrews,desc(IBU))
print(maxIBU[1,4])

##### Question 5 Answer #####
## Colorado has the highest ABV = 12.8, Oregon has the highest IBU = 138.
###################################################
###### Create DF for just the max ABV values ######
hABV <- buzzbrews %>% 
  group_by(State) %>% 
  dplyr::count(MaxABV = max(ABV), sort = TRUE)
hABV <- hABV[,-3]
hABV <- as.data.frame(hABV)
hABV$State <- trimws(hABV$State)
hABV$MaxABV <- as.numeric(hABV$MaxABV)
hABV <- hABV[order(-hABV$MaxABV),]
str(hABV)
view(hABV)

###################################################
###### Plot for Max ABV ###########################
hABV %>% 
  ggplot(aes(x=reorder(State, MaxABV), y= MaxABV)) + 
  geom_col(show.legend = FALSE, fill = "#c8102E", position = position_dodge(width = 1), na.rm = TRUE) + 
  geom_text(aes(label = MaxABV), hjust =-0.2, vjust=.4, size = 3, angle= 90) +
  theme_bw() + 
  theme(axis.text=element_text(size = 8, angle=65, hjust= .7)) +
  labs(title = "Max ABV by State in the USA", 
       subtitle = "Budweiser Consultation",
       y = "Max Alcohol By Volume by State",
       x = "State by Max ABV",
       caption="ABV imputed where necessary.") +
  theme_classic()

###################################################
###### Create DF for just the max IBU values ######
hIBU <- buzzbrews %>% 
  group_by(State) %>%
  dplyr::count(MaxIBU = max(IBU), sort = TRUE)
hIBU <- as.data.frame(hIBU)
hIBU <- hIBU[order(-hIBU$MaxIBU),]
str(hIBU)
hIBU <- hIBU[,-3]
hIBU$MaxIBU <- round(hIBU$MaxIBU, digits = 2)
hIBU

###################################################
############### Chart Max IBU #####################

hIBU %>% 
  ggplot(aes(x=reorder(State, MaxIBU), y= MaxIBU)) + 
  geom_col(show.legend = FALSE, fill = "#c8102E", position = position_dodge(width = 1), na.rm = TRUE) + 
  geom_text(aes(label = MaxIBU), hjust =-0.2, vjust=.4, size = 3, angle= 90) +
  theme_bw() + 
  theme(axis.text=element_text(size = 8, angle=65, hjust= .7)) +
  labs(title = "Max IBU by State in the USA", 
       subtitle = "Budweiser Consultation",
       y = "Max Int'l Bitterness Unit by State",
       x = "State by Max IBU",
       caption="ABV imputed where necessary.") +
  theme_classic()

```

# Question 6 - Comment on the summary statistics and distribution of the ABV variable.
#
# We observed summary statistics from the ABV data showing that once we filled in the missing 
# values as best as we could, there was a range of 0.10% to 12.80% with a median of 5.65% (median
# is simply the middle value if we were to arrange all the ABVs in either decending or ascending order).
#
# We also found a very common range within the overall range that went from 5.0% ABV to 6.70% ABV and 
# upon further review noticed this is where many commonly mass produced beers fall, for example: Bud 
# Ice (5.5%), Bud Light Platinum (6%), Natural Ice (5.9%), Bud Ice (5.5%), Budweiser (5%), Blue Moon 
# (5%), Stella Artois (5%), Heinekin (5%), Pabst Blue Ribbon (4.74%) and Miller Genuinine Draft (4.6%).


```{r}
######################
#                    #
#     Question 6     #
#                    #
######################
#############################################################################################################
#Comment on the summary statistics and distribution of the ABV variable.
#############################################################################################################
# Check on the distribution of ABV
hist(buzzbrews$ABV, col = "#c8102e",
     main = "Histogram of ABV Distribution",
     sub = "Busweiser Consultation",
     xlab = "ABV Ratings")
densityABV <- density(buzzbrews$ABV)
plot(densityABV, 
     main = "Kernel Density of Alcohol By Volume", 
     sub = "Budweiser Consultation",
     xlab = "ABV Ratings")
polygon(densityABV, col = "#c8102e")


ABVsummary <- summary(buzzbrews$ABV)
ABVsummary

############### Not sure what we want to do down here ##################
#ABVSumNames <- names(ABVsummary)
#ABVSumNames <- as.factor(ABVSumNames)
#ABVsummary <- as.list(unname(ABVsummary))
#ABVsum <- data.frame(ABVsummary)
#ABVsum <- (ABVSumNames)
#as.data.frame(ABVsum)
#ABVsum <- rename(ABVsum, "Summary"="", "Value"="ABVsummary")
########################################################################

```

# Question 7 - Is there an apparent relationship between the bitterness of the beer and its 
# alcoholic content? Draw a scatter plot.  Make your best judgment of a relationship and 
# EXPLAIN your answer.
#
# We used a scatter plot to viusally explore if there is any sort of relationship between 
# IBU and ABV, in other words can IBU determine ABV or can ABV be used to determine IBU. 
# There was evidence of a positive relationship, but and we will discuss this further shortly, 
# it appears one can potentially predict the other.


```{r}
######################
#                    #
#     Question 7     #
#                    #
######################
#############################################################################################################
#Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.  Make your best judgment of a relationship and EXPLAIN your answer.
#############################################################################################################


## Calculate slope and intercept of line of best fit ##
comparisonCoef <- coef(lm(ABV ~ IBU, buzzbrews))
comparisonCoef
#  (Intercept)    MaxIBU 
#   4.71799073  0.03142639 

buzzbrews %>% 
  ggplot(aes(x = IBU, y = ABV, color = "#c8102e")) +
  geom_point(show.legend = FALSE, na.rm = TRUE) +
  geom_abline(intercept =  comparisonCoef[1] , slope = comparisonCoef[2], color = "#c8102E", size = 1) +
  theme_classic() + 
  labs(title = "IBU vs ABV", 
       subtitle = "Budweiser Consultation",
       y = "Alcoholic By Volume", 
       x = "Int'l Bitterness Unit",
       caption="ABV and IBU values imputed where necessary.")

```


#Question 8 - .  Budweiser would also like to investigate the difference with respect to IBU and ABV 
# between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its name other than IPA).
# You decide to use KNN classification to investigate this relationship.  Provide statistical evidence one
# way or the other. You can of course assume your audience is comfortable with percentages … KNN is very easy 
# to understand conceptually.
#In addition, while you have decided to use KNN to investigate this relationship (KNN is required) you may
# also feel free to supplement your response to this question with any other methods or techniques you have
# learned.  Creativity and alternative solutions are always encouraged.  
#
# We built a kNN (nearest neighbor) classifier to see if there is a difference between IPA and Ale, and while
# we were at it, we also added in a third class called, "neither." In building the kNN, we wanted to explore 
# what the appropriate number of "neighbors" was to compare to since there is so many observations so close
# together (think New York city and all the noise generated). We found that generally 8 neighbors were the 
# best estimation (we randomly parsed the data 100 times to find the best neighbors value). 
#
# Our classifier was accurate in determining if a beer was an Ale, IPA or neither about 64.5% of the time
# when we used 8 nearest neighbors.
# Next we created some random pairings of IBU and ABV to see how the classifier handled the data and discovered 
# it again was about 64.5% accurate. It is far more accurate identifyly neither style of beer 78% of the time, 
# then IPAs 67.5% of the time and Ale's 26% of the time.
# We also look a look at the ranges for IBU and ABV for each of the 3 broad types of beers IPA, Ale or 
# "neither" and found the following results, showing that it should be more difficult to predict between 
# the 3 different types of beers.
# 
# IPAAle  ABV.min ABV.med ABV.max IBU.min IBU.med IBU.max
# Ale         3.5     5.4    12.8       7    31       120
# IPA         4       6.7     9.9      19    67.6     138
# neither     0.1     5.5    12.5       0    28       130



```{r}
######################
#                    #
#     Question 8     #
#                    #
######################
#############################################################################################################
#Budweiser would also like to investigate the difference with respect to IBU and ABV between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its name other than IPA).  You decide to use KNN classification to investigate this relationship.  Provide statistical evidence one way or the other. You can of course assume your audience is comfortable with percentages … KNN is very easy to understand conceptually
#############################################################################################################
#############################################################################################################
#In addition, while you have decided to use KNN to investigate this relationship (KNN is required) you may also feel free to supplement your response to this question with any other methods or techniques you have learned.  Creativity and alternative solutions are always encouraged.
#############################################################################################################


#Label Ales, IPAs and neither
buzzbrews$IPAAle = case_when(grepl("\\bIPA\\b", buzzbrews$Beer, ignore.case = TRUE) ~ "IPA",
                             grepl("\\bindia pale ale\\b", buzzbrews$Beer, ignore.case = TRUE) ~ "IPA",
                             grepl("\\bale\\b", buzzbrews$Beer, ignore.case = TRUE ) ~ "Ale",
                             TRUE ~ "neither")
view(buzzbrews)

##### Find the best value of K and train the model ##############
iterations = 100
numks = 100
splitPerc = .70
set.seed(33)

masterAcc = matrix(nrow = iterations, ncol = numks)
  
for(j in 1:iterations)
{
accs = data.frame(accuracy = numeric(30), k = numeric(30))
trainIndices = sample(1:dim(buzzbrews)[1],round(splitPerc * dim(buzzbrews)[1]))
train = buzzbrews[trainIndices,]
test = buzzbrews[-trainIndices,]
for(i in 1:numks)
  {
  classifications = knn(train[,c(7,8)],test[,c(7,8)],train$IPAAle, prob = TRUE, k = i)
  table(classifications,test$IPAAle)
  CM = confusionMatrix(table(classifications,test$IPAAle))
  masterAcc[j,i] = CM$overall[1]
  }
}

MeanAcc = colMeans(masterAcc)
# Visually find the best value of k by using it's location in the dataframe based on the highest Mean value
plot(seq(1,numks,1),MeanAcc, type = "l")

# Locate the value of k based on the best MeanAcc in the dataframe
kvalue = match(max(MeanAcc), MeanAcc)
kvalue
max(MeanAcc)

####### Best value of k = 8 at 63.4% Accuracy #####################
####### Train the model using k = 8 #####################
for(i in 1:iterations)
  {
  knn(train[,c(7,8)],test[,c(7,8)],train$IPAAle, prob = TRUE, k = kvalue)
  }

classifications = knn(train[,c(7,8)],test[,c(7,8)],train$IPAAle, prob = TRUE, k = kvalue)
  table(classifications,test$IPAAle)
  CM = confusionMatrix(table(classifications,test$IPAAle))
CM


####### Test the Classifier with some random data ###
classifyMyBeers <- data.frame(ABV = c(6,6,5,4,5, 12, 7), 
       IBU = c(78, 65, 55, 38, 100, 148, 98))
classifications = knn(train[,c(7,8)],classifyMyBeers,train$IPAAle, prob = TRUE, k = kvalue)

classifications


############ Test Results #######################
#Class: neither   Ale       Ale       neither   IPA       neither   IPA    
#Prob:  0.6250000 0.6250000 0.6250000 0.7500000 0.7500000 0.5000000 0.7777778
##################################################


############# Summary data by classification #############
IPAAleSummary <- buzzbrews %>% 
  group_by(IPAAle) %>% 
  dplyr::summarise(ABV.min = min(ABV), 
                   ABV.med = median(ABV),
                   ABV.max = max(ABV), 
                   IBU.min = min(IBU), 
                   IBU.med = median(IBU),
                   IBU.max = max(IBU))
IPAAleSummary

```

```{r}
######################
#                    #
#     Question 9     #
#                    #
######################
#############################################################################################################
#Knock their socks off!  Find one other useful inference from the data that you feel Budweiser may be able to find value in.  You must convince them why it is important and back up your conviction with appropriate statistical evidence. 
#############################################################################################################
```